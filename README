# ESP32-C3 Automated Water Top-Off System ğŸŒ±

An intelligent, automated water management system built on ESP32-C3, featuring advanced sensor algorithms, web-based control, cloud logging, and **secure credential management** with dual-mode operation.

![ESP32-C3](https://img.shields.io/badge/ESP32-C3-blue)
![Platform](https://img.shields.io/badge/PlatformIO-Compatible-orange)
![License](https://img.shields.io/badge/License-MIT-green)
![Build](https://img.shields.io/badge/Build-Passing-brightgreen)
![Security](https://img.shields.io/badge/Security-AES256-red)

## ğŸš€ Features

### Core Functionality
- **Intelligent Water Level Detection** - Dual float sensor system with advanced timing algorithms
- **Automated Pump Control** - Precise volume delivery with configurable flow rates
- **Algorithm-Driven Decision Making** - Smart timing analysis for optimal water management
- **Error Detection & Recovery** - Built-in safety mechanisms and failure handling

### ğŸ” Security & Credential Management (NEW!)
- **Dual-Mode Operation** - Programming Mode for setup, Production Mode for operation
- **FRAM Credential Storage** - Encrypted WiFi/Admin/VPS credentials stored in non-volatile FRAM
- **CLI Programming Interface** - Secure command-line interface for credential programming
- **Dynamic Credential Loading** - Automatic loading from FRAM with hardcoded fallback
- **AES-256 Encryption** - Military-grade encryption for sensitive data protection

### Web Interface
- **Professional Dashboard** - Real-time monitoring and control
- **Mobile-Responsive Design** - Works on desktop, tablet, and mobile
- **Secure Authentication** - Password protection with session management
- **Rate Limiting** - Protection against abuse and unauthorized access

### Data Management
- **FRAM Storage** - Non-volatile data persistence for settings and cycle history
- **VPS Cloud Logging** - Remote monitoring and data analytics
- **Statistical Tracking** - Error counts, performance metrics, and trends
- **Real-Time Clock Integration** - Accurate timestamping with DS3231 or internal RTC fallback

### RTC Recovery Logic
- **Normal operation**  
  When a DS3231 is detected and initialized successfully, it becomes the primary source of time.  

- **Power loss on DS3231**  
  If the DS3231 reports that it has lost power, the firmware automatically restores time from the **firmware compile timestamp** (`__DATE__`, `__TIME__`).  
  This ensures the RTC always has a valid baseline time, even after a complete power failure.  

- **No DS3231 detected**  
  If no external RTC is found on the IÂ²C bus, the system falls back to the **ESP32 internal RTC**.  
  - First, it tries to obtain system time (`getLocalTime`).  
  - If that fails, it falls back to the **firmware compile timestamp**.  

- **Important notes**  
  - After recovery, the reported time may be **behind the real current time** (reset to firmware build date).  
  - For applications requiring precise or real-time synchronization, it is recommended to **set the time manually via CLI/API** after such an event.  
  - API endpoints (e.g. `/api/status`) will always indicate which time source is in use via the `rtc_info` field:  
    - `"Using DS3231 external RTC"`  
    - `"Using ESP32 internal RTC (fallback mode)"` 

### Safety & Security
- **IP Whitelisting** - Restrict access to authorized devices
- **Session Management** - Secure token-based authentication
- **Global Pump Control** - Emergency disable with auto-recovery
- **Comprehensive Logging** - Debug and audit trail capabilities

## ğŸ¯ Dual-Mode System Architecture

The system operates in two distinct modes with conditional compilation:

### ğŸ”§ Programming Mode
- **Purpose**: Secure credential programming and system setup
- **Features**: 
  - CLI interface via Serial
  - FRAM credential programming
  - Encryption/decryption testing
  - JSON configuration support
  - Water system DISABLED for security
- **Access**: `pio run -e programming`

### ğŸ­ Production Mode  
- **Purpose**: Full water system operation
- **Features**:
  - Complete water management system
  - Dynamic credential loading from FRAM
  - Web interface and API
  - VPS logging with FRAM credentials
  - CLI interface DISABLED for security
- **Access**: `pio run -e production`

## ğŸ“‹ Hardware Requirements

### Minimum Requirements
- **ESP32-C3** (Seeed Xiao ESP32-C3 recommended)
- **2x Float Sensors** (NC type with pull-up resistors)
- **Water Pump** with relay control (12V recommended)
- **Power Supply** (5V/2A minimum)

### Recommended Add-ons
- **DS3231 RTC Module** (I2C) for accurate timekeeping
- **FRAM I2C Memory** (32KB) for data persistence and **credential storage** ğŸ†•
- **Status LED** for visual feedback
- **Reset Button** for error recovery

### Pin Configuration (Seeed Xiao ESP32-C3)
```
Pin 2:  Pump Relay Control
Pin 3:  Water Sensor 1 (Float Switch)
Pin 4:  Water Sensor 2 (Float Switch) 
Pin 5:  Status LED
Pin 6:  RTC/FRAM SDA (I2C)
Pin 7:  RTC/FRAM SCL (I2C)
Pin 9:  Error Signal Output
Pin 10: Reset Button Input
```

## ğŸ› ï¸ Installation

### Prerequisites
- [PlatformIO](https://platformio.org/) installed
- [Git](https://git-scm.com/) for version control
- Basic electronics knowledge for hardware assembly

### 1. Clone Repository
```bash
git clone https://github.com/yourusername/esp32-water-system.git
cd esp32-water-system
```

### 2. Hardware Setup
Assemble hardware according to [Hardware Setup Guide](docs/hardware-setup.md).

**âš ï¸ IMPORTANT**: Install FRAM memory module for credential storage!

### 3. Credential Programming (First Time Setup)

#### Step 3a: Upload Programming Mode
```bash
# Upload programming firmware
pio run -e programming -t upload

# Open CLI interface
pio device monitor -e programming
```

#### Step 3b: Program Credentials via CLI
```
FRAM> help                    # Show available commands
FRAM> detect                  # Verify FRAM is connected
FRAM> program                 # Interactive credential programming
```

**Interactive Programming Example:**
```
Device Name: DOLEWKA
WiFi SSID: YourWiFiNetwork
WiFi Password: YourWiFiPassword
Admin Password: your_new_admin_password
VPS Token: your_vps_auth_token_here
```

#### Step 3c: Verify Programming
```
FRAM> verify                  # Confirm credentials are stored correctly
FRAM> info                    # Show FRAM status and device info
```

### 4. Production Deployment

#### Step 4a: Upload Production Mode
```bash
# Upload production firmware  
pio run -e production -t upload

# Monitor startup logs
pio device monitor -e production
```

#### Step 4b: Verify Dynamic Loading
Check startup logs for:
```
âœ… Credentials loaded from FRAM successfully
Device ID: DOLEWKA
WiFi connected - Using FRAM credentials
```

### 5. Access Web Interface
Once connected to WiFi, access the dashboard at:
```
http://192.168.0.164
```
Login with the admin password you programmed in Step 3b.

## ğŸ”§ Configuration

### Programming Mode Commands

| Command | Description | Example |
|---------|-------------|---------|
| `help` | Show all commands | `FRAM> help` |
| `detect` | Check FRAM connectivity | `FRAM> detect` |
| `info` | Show device information | `FRAM> info` |
| `program` | Interactive credential setup | `FRAM> program` |
| `config` | JSON-based configuration | `FRAM> config` |
| `verify` | Verify stored credentials | `FRAM> verify` |
| `backup` | Backup FRAM contents | `FRAM> backup` |
| `test` | Run system tests | `FRAM> test` |

### JSON Configuration Example
```bash
FRAM> config
```
```json
{
  "device_name": "DOLEWKA",
  "wifi_ssid": "YourNetwork", 
  "wifi_password": "YourPassword",
  "admin_password": "newadmin123",
  "vps_token": "212d4a3d708f907c2c782937f72daf28aa66d8e342d4ede15381b6d8295344d6"
}
```

### Algorithm Parameters
Located in `src/algorithm/algorithm_config.h`:

```cpp
#define TIME_TO_PUMP            450    // Seconds from trigger to pump start
#define TIME_GAP_1_MAX          300    // Max wait for second sensor (Mode 1)
#define TIME_GAP_2_MAX          300    // Max wait for second sensor (Mode 2)
#define THRESHOLD_1             180    // Threshold for TIME_GAP_1 evaluation
#define THRESHOLD_2             60     // Threshold for TIME_GAP_2 evaluation
#define WATER_TRIGGER_MAX_TIME  120    // Max time for sensor response after pump
#define PUMP_MAX_ATTEMPTS       3      // Max pump retry attempts
#define SINGLE_DOSE_VOLUME      100    // ml per pump cycle
#define FILL_WATER_MAX          2400   // ml maximum daily volume
```

### Pump Settings
Configurable via web interface:
- **Volume per Second**: 0.1 - 20.0 ml/s
- **Normal Cycle Duration**: Default 15 seconds
- **Extended Cycle Duration**: Default 30 seconds (calibration)

## ğŸ“Š Security Model

### Credential Storage
- **Encryption**: AES-256-CBC with device-specific keys
- **Storage**: Non-volatile FRAM memory
- **Access**: Programming mode only
- **Fallback**: Hardcoded credentials when FRAM empty

### Mode Separation
- **Programming Mode**: CLI enabled, water system disabled
- **Production Mode**: CLI disabled, water system enabled
- **Conditional Compilation**: Eliminates unused code from each build

### Authentication
- **Admin Password**: SHA-256 hashed, stored encrypted in FRAM
- **Session Management**: Token-based with configurable timeout
- **Rate Limiting**: Protection against brute force attacks

## ğŸ”„ Production Workflow

### Initial Setup
1. **Program Credentials**: Use Programming Mode CLI
2. **Deploy Production**: Upload Production Mode firmware
3. **Verify Operation**: Check dynamic credential loading
4. **Monitor System**: Use web dashboard and logs

### Credential Updates
1. **Switch to Programming**: Upload Programming Mode
2. **Update Credentials**: Use CLI interface 
3. **Verify Changes**: Test new credentials
4. **Redeploy Production**: Upload Production Mode

### Maintenance
- **Backup FRAM**: Use `backup` command before changes
- **Monitor Statistics**: Check error counts via web interface
- **Update Settings**: Adjust pump parameters as needed

## ğŸ“ˆ Monitoring & Analytics

### Local Data
- **FRAM Storage**: Last 200 pump cycles (14 days typical)
- **Error Statistics**: Gap1, Gap2, Water trigger failure counts
- **Daily Volume Tracking**: Automatic reset every 24 hours
- **Encrypted Credentials**: Secure storage of sensitive data

### Cloud Integration
Optional VPS logging includes:
- Pump cycle completion events
- Volume delivered and timing data
- Algorithm performance metrics
- Error statistics and trends
- System health status
- **Dynamic Device ID**: From FRAM credentials

### Data Format
```json
{
  "device_id": "DOLEWKA",               // From FRAM
  "timestamp": "2024-01-15 14:30:00",
  "event_type": "AUTO_CYCLE_COMPLETE",
  "volume_ml": 150,
  "time_gap_1": 45,
  "time_gap_2": 22,
  "water_trigger_time": 8,
  "gap1_fail_sum": 3,
  "gap2_fail_sum": 1,
  "water_fail_sum": 0,
  "algorithm_data": "THRESHOLDS(GAP1:180s,GAP2:60s,WATER:30s) CURRENT(0-0-0) SUMS(3-1-0)"
}
```

## ğŸ›¡ï¸ Security Features

- **AES-256 Encryption**: Military-grade credential protection
- **Device-Specific Keys**: Unique encryption keys per device
- **Mode Isolation**: Separate programming and production modes
- **Password Authentication**: SHA-256 hashed passwords
- **Session Management**: Token-based with configurable timeout
- **Rate Limiting**: Prevents brute force attacks
- **IP Filtering**: Whitelist trusted devices
- **Request Throttling**: Configurable limits per IP

## ğŸ› Troubleshooting

### Credential Issues

**FRAM Not Detected**
```bash
# Programming Mode
FRAM> detect
[ERROR] FRAM not found
```
- Verify I2C wiring (SDA=Pin6, SCL=Pin7)
- Check FRAM power supply (3.3V)
- Test I2C bus with multimeter

**Credential Loading Failed**
```
[WARN] Could not load credentials from FRAM, using fallback
```
- Credentials may not be programmed yet
- Use Programming Mode to verify: `FRAM> verify`
- Check FRAM memory integrity: `FRAM> test`

**Authentication Failed**
- Verify admin password matches programmed credential
- Use Programming Mode to check: `FRAM> verify`
- Reset credentials if necessary: `FRAM> program`

### Mode Switching Issues

**Programming Mode Not Working**
- Verify correct firmware uploaded: `pio run -e programming -t upload`
- Check serial monitor connection and baud rate (115200)
- Try reset button or power cycle

**Production Mode Not Loading Credentials**
- Check FRAM initialization logs on startup
- Verify credentials programmed: Switch to Programming Mode
- Check FRAM memory layout version

### Common Issues

**WiFi Connection Failed**
- In Programming Mode: `FRAM> verify` to check stored credentials
- Update credentials: `FRAM> program`
- Check signal strength and network settings

**Web Interface Inaccessible**
- Verify Production Mode is uploaded and running
- Check credential loading in startup logs
- Confirm ESP32 connected to WiFi with FRAM credentials

**VPS Logging Failed**
- Check VPS token in programmed credentials
- Verify network connectivity
- Monitor logs for HTTP error codes

### Debug Mode
Enable detailed logging in Programming Mode:
```
FRAM> test      # Run comprehensive system tests
FRAM> info      # Show detailed system information
```

## ğŸ›ï¸ Platform Configuration

### Build Environments
```ini
# Programming Mode
[env:programming]
build_flags = -DPROGRAMMING_MODE
lib_deps = 
    AsyncTCP
    ArduinoJson
    RTClib
    Adafruit FRAM I2C

# Production Mode  
[env:production]
build_flags = -DPRODUCTION_MODE
lib_deps = 
    ESPAsyncWebServer
    AsyncTCP
    ArduinoJson
    RTClib
    Adafruit FRAM I2C
```

### Memory Layout
```
FRAM Memory (32KB):
0x0000-0x0017: Common validation area
0x0018-0x0417: Encrypted credentials (1024 bytes)
0x0500+:       ESP32 water system data
```

## ğŸ¤ Contributing

We welcome contributions! Please see [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

### Development Setup
1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Test in both Programming and Production modes
4. Commit changes (`git commit -m 'Add amazing feature'`)
5. Push to branch (`git push origin feature/amazing-feature`)
6. Open Pull Request

## ğŸ“„ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## ğŸ‘¥ Authors & Acknowledgments

- **Primary Developer** - System architecture and algorithm development
- **Security Integration** - FRAM programmer and dual-mode implementation
- **Contributors** - See [Contributors](https://github.com/yourusername/esp32-water-system/contributors)

### Special Thanks
- Arduino/ESP32 community for excellent libraries
- PlatformIO team for the development platform
- Adafruit for hardware libraries and documentation
- **FRAM programmer project** for encryption foundation

## ğŸ“š Documentation

- [Hardware Assembly Guide](docs/hardware-setup.md) - **Updated for FRAM requirements**
- [Algorithm Documentation](docs/algorithm-details.md)
- [API Reference](docs/api-reference.md) - **Updated for dynamic credentials**
- [Troubleshooting Guide](docs/troubleshooting.md)
- **[Credential Management Guide](docs/credential-management.md)** - NEW!

## ğŸ”„ Changelog

### v2.0.0 - Dual-Mode Security Update
- âœ… **NEW**: Dual-mode operation (Programming/Production)
- âœ… **NEW**: FRAM credential storage with AES-256 encryption
- âœ… **NEW**: CLI programming interface
- âœ… **NEW**: Dynamic credential loading
- âœ… **SECURITY**: Mode isolation and conditional compilation
- âœ… **ENHANCED**: Unified FRAM memory layout

See [CHANGELOG.md](CHANGELOG.md) for complete version history.

## ğŸ“ Support

- ğŸ› **Bug Reports**: [Issues](https://github.com/yourusername/esp32-water-system/issues)
- ğŸ’¡ **Feature Requests**: [Discussions](https://github.com/yourusername/esp32-water-system/discussions)
- ğŸ”’ **Security Issues**: security@yourdomain.com
- ğŸ“§ **General Contact**: your-email@domain.com

---

â­ **Star this repository if it helped you!** â­

ğŸ” **Now featuring secure credential management for production deployments!** ğŸ”